<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Diary - Site Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; }
        h1 { margin-bottom: 20px; }
        
        /* Navigation */
        .top-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .top-nav button { padding: 10px 20px; cursor: pointer; }
        
        /* Tab Navigation */
        .tab-nav { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
        .tab-nav button { padding: 10px 15px; background: #f0f0f0; border: none; cursor: pointer; }
        .tab-nav button.active { background: #007bff; color: white; }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Forms */
        .form-section { margin-bottom: 30px; }
        .form-section h3 { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin-bottom: 15px; align-items: start; }
        .form-row label { font-weight: bold; padding-top: 8px; }
        .form-row input, .form-row select, .form-row textarea { padding: 8px; border: 1px solid #ddd; width: 100%; }
        .form-row textarea { min-height: 100px; }
        .required::after { content: " *"; color: red; }
        
        /* Dynamic Arrays */
        .array-container { margin-bottom: 20px; }
        .array-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .add-btn { padding: 8px 15px; background: #28a745; color: white; border: none; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f8f8; }
        td input, td select { width: 100%; padding: 5px; border: 1px solid #ddd; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .totals { background: #f0f8ff; padding: 10px; margin-top: 10px; font-weight: bold; }
        
        /* Status Indicators */
        .status-red { color: #dc3545; }
        .status-amber { color: #ffc107; }
        .status-green { color: #28a745; }
        
        /* Signature */
        #signatureCanvas { border: 1px solid #ddd; cursor: crosshair; background: white; }
        .signature-controls { margin-top: 10px; }
        
        /* Save Button */
        .save-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; }
        .save-btn { padding: 15px 30px; background: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; font-weight: bold; }
        .save-btn:hover { background: #0056b3; }
        
        /* Message */
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .message.success { background: #d4edda; color: #155724; display: block; }
        .message.error { background: #f8d7da; color: #721c24; display: block; }
        
        /* Entries List */
        .entries-list { margin-top: 20px; }
        .entry-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; background: #f9f9f9; }
        .entry-card h3 { margin-bottom: 10px; }
        .entry-actions { margin-top: 10px; }
        .entry-actions button { margin-right: 10px; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Construction Daily Diary</h1>
        
        <!-- Top Navigation -->
        <div class="top-nav">
            <button onclick="showView('form')">+ New Entry</button>
            <button onclick="showView('list')">Diary Entries</button>
        </div>
        
        <div id="message" class="message"></div>
        
        <!-- Form View -->
        <div id="formView">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="active" onclick="showTab(1)">1. General</button>
                <button onclick="showTab(2)">2. Personnel</button>
                <button onclick="showTab(3)">3. Equipment</button>
                <button onclick="showTab(4)">4. Work Progress</button>
                <button onclick="showTab(5)">5. Delays</button>
                <button onclick="showTab(6)">6. Safety & Weather</button>
                <button onclick="showTab(7)">7. Production</button>
                <button onclick="showTab(8)">8. Events</button>
            </div>
            
            <!-- Tab 1: General -->
            <div class="tab-content active" id="tab1">
                <div class="form-section">
                    <h3>Contract & Identification</h3>
                    <div class="form-row">
                        <label class="required">Contract Number</label>
                        <input type="text" id="contractNumber" placeholder="e.g. 24029" required>
                    </div>
                    <div class="form-row">
                        <label class="required">Site Supervisor</label>
                        <input type="text" id="siteSupervisor" placeholder="Enter supervisor name" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Project Information</h3>
                    <div class="form-row">
                        <label class="required">Project Name</label>
                        <input type="text" id="projectName" placeholder="e.g. SMH/Addax" required>
                    </div>
                    <div class="form-row">
                        <label class="required">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-row">
                        <label>Project Location</label>
                        <input type="text" id="projectLocation" placeholder="e.g. Nouakchott, Mauritania">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Weather Conditions</h3>
                    <div class="form-row">
                        <label>Weather Condition</label>
                        <select id="weatherCondition">
                            <option value="">Select...</option>
                            <option>Sunny</option>
                            <option>Cloudy</option>
                            <option>Rainy</option>
                            <option>Windy</option>
                            <option>Hot</option>
                            <option>Cold</option>
                            <option>Stormy</option>
                            <option>Foggy</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Min Temperature (°C)</label>
                        <input type="number" id="minTemp" placeholder="e.g. 22">
                    </div>
                    <div class="form-row">
                        <label>Max Temperature (°C)</label>
                        <input type="number" id="maxTemp" placeholder="e.g. 27">
                    </div>
                    <div class="form-row">
                        <label>Wind Speed (km/h)</label>
                        <input type="number" id="windSpeed" placeholder="e.g. 5">
                    </div>
                    <div class="form-row">
                        <label>Humidity (%)</label>
                        <input type="number" id="humidity" placeholder="e.g. 65">
                    </div>
                    <div class="form-row">
                        <label>Rainfall (mm)</label>
                        <input type="number" id="rainfall" placeholder="e.g. 15" onchange="toggleRainfallDuration()">
                    </div>
                    <div class="form-row" id="rainfallDurationRow" style="display:none;">
                        <label>Rainfall Duration (hours)</label>
                        <input type="number" id="rainfallDuration" placeholder="e.g. 3.5" step="0.5">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Daily Summaries</h3>
                    <div class="form-row">
                        <label>Work Completed Summary</label>
                        <textarea id="workCompleted" placeholder="Provide a general summary of work completed today"></textarea>
                    </div>
                    <div class="form-row">
                        <label>Issues or Delays Summary</label>
                        <textarea id="issuesDelays" placeholder="Summarize any issues, delays or blockers"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: Personnel -->
            <div class="tab-content" id="tab2">
                <div class="array-container">
                    <div class="array-header">
                        <h3>Personnel on Site</h3>
                        <button class="add-btn" onclick="addPersonnel()">Add Person</button>
                    </div>
                    <table id="personnelTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role Category</th>
                                <th>Role / Job Title</th>
                                <th>Hours</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="personnelBody">
                        </tbody>
                    </table>
                    <div class="totals" id="personnelTotals">
                        Total Staff: 0 | Total Hours: 0 | Total Manhours: 0
                    </div>
                </div>
            </div>
            
            <!-- Tab 3: Equipment -->
            <div class="tab-content" id="tab3">
                <div class="array-container">
                    <div class="array-header">
                        <h3>Equipment & Resources</h3>
                        <button class="add-btn" onclick="addEquipment()">Add Equipment</button>
                    </div>
                    <table id="equipmentTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Hours Worked</th>
                                <th>Condition</th>
                                <th>Remarks</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab 4: Work Progress -->
            <div class="tab-content" id="tab4">
                <div class="array-container">
                    <div class="array-header">
                        <h3>Work Progress</h3>
                        <button class="add-btn" onclick="addActivity()">Add Activity</button>
                    </div>
                    <table id="activityTable">
                        <thead>
                            <tr>
                                <th>Activity Code</th>
                                <th>Description</th>
                                <th>Planned %</th>
                                <th>Actual %</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="activityBody">
                        </tbody>
                    </table>
                    <div class="totals" id="activityTotals">
                        Avg Planned: 0% | Avg Actual: 0% | Variance: 0%
                    </div>
                </div>
            </div>
            
            <!-- Tab 5: Delays -->
            <div class="tab-content" id="tab5">
                <div class="array-container">
                    <div class="array-header">
                        <h3>Delay Causes and Impact</h3>
                        <button class="add-btn" onclick="addDelay()">Add Delay Cause</button>
                    </div>
                    <table id="delayTable">
                        <thead>
                            <tr>
                                <th>Cause Type</th>
                                <th>Description</th>
                                <th>Impact</th>
                                <th>Hours Lost</th>
                                <th>Affected Activities</th>
                                <th>Action Taken</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="delayBody">
                        </tbody>
                    </table>
                    <div class="totals" id="delayTotals">
                        Total Hours Lost: 0
                    </div>
                </div>
            </div>
            
            <!-- Tab 6: Safety & Weather -->
            <div class="tab-content" id="tab6">
                <div class="form-section">
                    <h3>Health & Safety</h3>
                    <div class="form-row">
                        <label>Incidents</label>
                        <textarea id="incidents" placeholder="Describe any incidents or near-misses"></textarea>
                    </div>
                    <div class="form-row">
                        <label>Safety Inspections</label>
                        <textarea id="safetyInspections" placeholder="Inspections performed, issues found"></textarea>
                    </div>
                    <div class="form-row">
                        <label>PPE Compliance</label>
                        <input type="text" id="ppeCompliance" placeholder="e.g. 100% compliant">
                    </div>
                    <div class="form-row">
                        <label>First Aid/Medical</label>
                        <textarea id="firstAid" placeholder="Any first aid cases, treatments provided"></textarea>
                    </div>
                </div>
                
                <div class="array-container">
                    <div class="array-header">
                        <h3>Weather Impact</h3>
                        <button class="add-btn" onclick="addWeatherImpact()">Add Weather Impact</button>
                    </div>
                    <table id="weatherImpactTable">
                        <thead>
                            <tr>
                                <th>Impact Type</th>
                                <th>Severity</th>
                                <th>Affected Activities</th>
                                <th>Duration (hours)</th>
                                <th>Mitigation Actions</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="weatherImpactBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab 7: Production & Photos -->
            <div class="tab-content" id="tab7">
                <div class="array-container">
                    <div class="array-header">
                        <h3>Materials Delivered</h3>
                        <button class="add-btn" onclick="addMaterial()">Add Material</button>
                    </div>
                    <table id="materialTable">
                        <thead>
                            <tr>
                                <th>Material Type</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="materialBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="form-section">
                    <h3>Materials & Production</h3>
                    <div class="form-row">
                        <label>Materials Needed Tomorrow</label>
                        <textarea id="materialsNeeded" placeholder="List materials expected or needed"></textarea>
                    </div>
                    <div class="form-row">
                        <label>Production Issues/Delays</label>
                        <textarea id="productionIssues" placeholder="Details of production delays"></textarea>
                    </div>
                </div>
                
                <div class="array-container">
                    <div class="array-header">
                        <h3>Visitors Log</h3>
                        <button class="add-btn" onclick="addVisitor()">Add Visitor</button>
                    </div>
                    <table id="visitorTable">
                        <thead>
                            <tr>
                                <th>Visitor Name</th>
                                <th>Company/Firm</th>
                                <th>Purpose</th>
                                <th>Time On Site</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="visitorBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="form-section">
                    <h3>General Comments & Photos</h3>
                    <div class="form-row">
                        <label>Other Comments</label>
                        <textarea id="generalComments" placeholder="Any events impacting site like strikes, holidays, etc."></textarea>
                    </div>
                    <div class="form-row">
                        <label>Photos (Note: For MVP demo)</label>
                        <input type="text" id="photos" placeholder="Photo upload coming in Phase 2">
                    </div>
                </div>
            </div>
            
            <!-- Tab 8: Events & Instructions -->
            <div class="tab-content" id="tab8">
                <div class="array-container">
                    <div class="array-header">
                        <h3>Events, Instructions & Variations</h3>
                        <button class="add-btn" onclick="addEvent()">Add Event</button>
                    </div>
                    <table id="eventTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Source</th>
                                <th>Cost Impact</th>
                                <th>Liability</th>
                                <th>Reference</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="eventBody">
                        </tbody>
                    </table>
                    <div class="totals" id="eventTotals">
                        Total Events: 0
                    </div>
                </div>
                
                <!-- Signature Section -->
                <div class="form-section">
                    <h3>Acceptance & Sign-Off</h3>
                    <div class="form-row">
                        <label>Completed By</label>
                        <input type="text" id="completedBy" readonly>
                    </div>
                    <div class="form-row">
                        <label>Digital Signature</label>
                        <div>
                            <canvas id="signatureCanvas" width="400" height="150"></canvas>
                            <div class="signature-controls">
                                <button onclick="clearSignature()">Clear Signature</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="required">Confirmation</label>
                        <div>
                            <input type="checkbox" id="confirmAccurate" required>
                            <label for="confirmAccurate" style="display: inline; font-weight: normal;">
                                I confirm that the information in this diary entry is accurate to the best of my knowledge
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Button (visible on all tabs) -->
            <div class="save-section">
                <button class="save-btn" onclick="saveDiaryEntry()">Save Diary Entry</button>
            </div>
        </div>
        
        <!-- List View -->
        <div id="listView" style="display: none;">
            <h2>Diary Entries</h2>
            <div class="entries-list" id="entriesList">
                <!-- Entries will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global data arrays
        let personnel = [];
        let equipment = [];
        let activities = [];
        let delays = [];
        let weatherImpacts = [];
        let materials = [];
        let visitors = [];
        let events = [];
        
        // Signature canvas
        let canvas, ctx, isDrawing = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            document.getElementById('date').valueAsDate = new Date();
            
            // Initialize signature canvas
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch support
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Auto-fill completed by
            document.getElementById('siteSupervisor').addEventListener('change', function() {
                document.getElementById('completedBy').value = this.value;
            });
        });
        
        // Tab Navigation
        function showTab(tabNum) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-nav button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('tab' + tabNum).classList.add('active');
            document.querySelectorAll('.tab-nav button')[tabNum - 1].classList.add('active');
        }
        
        // View Navigation
        function showView(view) {
            if (view === 'form') {
                document.getElementById('formView').style.display = 'block';
                document.getElementById('listView').style.display = 'none';
                clearForm();
            } else {
                document.getElementById('formView').style.display = 'none';
                document.getElementById('listView').style.display = 'block';
                loadEntries();
            }
        }
        
        // Rainfall duration toggle
        function toggleRainfallDuration() {
            const rainfall = parseFloat(document.getElementById('rainfall').value) || 0;
            document.getElementById('rainfallDurationRow').style.display = rainfall > 0 ? 'grid' : 'none';
        }
        
        // Personnel Functions
        function addPersonnel() {
            const row = {
                id: Date.now(),
                name: '',
                roleCategory: '',
                roleTitle: '',
                hours: 8
            };
            personnel.push(row);
            renderPersonnel();
        }
        
        function removePersonnel(id) {
            personnel = personnel.filter(p => p.id !== id);
            renderPersonnel();
        }
        
        function renderPersonnel() {
            const tbody = document.getElementById('personnelBody');
            tbody.innerHTML = '';
            
            const roleCategories = ['', 'Site Manager', 'Supervisor', 'Engineer', 'Contractor', 'QC', 'Operator', 
                                   'Team Leader', 'Skilled', 'Semi-Skilled', 'Unskilled', 'Project Manager', 'Junior Engineer'];
            
            personnel.forEach(person => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${person.name}" onchange="updatePersonnel(${person.id}, 'name', this.value)"></td>
                    <td>
                        <select onchange="updatePersonnel(${person.id}, 'roleCategory', this.value)">
                            ${roleCategories.map(cat => `<option value="${cat}" ${person.roleCategory === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${person.roleTitle}" onchange="updatePersonnel(${person.id}, 'roleTitle', this.value)"></td>
                    <td><input type="number" value="${person.hours}" onchange="updatePersonnel(${person.id}, 'hours', parseFloat(this.value))"></td>
                    <td><button class="delete-btn" onclick="removePersonnel(${person.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            updatePersonnelTotals();
        }
        
        function updatePersonnel(id, field, value) {
            const person = personnel.find(p => p.id === id);
            if (person) {
                person[field] = value;
                updatePersonnelTotals();
            }
        }
        
        function updatePersonnelTotals() {
            const totalStaff = personnel.length;
            const totalHours = personnel.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0);
            const totalManhours = personnel.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0);
            
            document.getElementById('personnelTotals').textContent = 
                `Total Staff: ${totalStaff} | Total Hours: ${totalHours.toFixed(1)} | Total Manhours: ${totalManhours.toFixed(1)}`;
        }
        
        // Equipment Functions
        function addEquipment() {
            const row = {
                id: Date.now(),
                type: '',
                quantity: 1,
                hours: 8,
                condition: 'Good',
                remarks: ''
            };
            equipment.push(row);
            renderEquipment();
        }
        
        function removeEquipment(id) {
            equipment = equipment.filter(e => e.id !== id);
            renderEquipment();
        }
        
        function renderEquipment() {
            const tbody = document.getElementById('equipmentBody');
            tbody.innerHTML = '';
            
            const equipmentTypes = ['', 'Excavator', 'Dump truck', 'Compactor', 'Grader', 'Loader', 'Flatbed (30 ton)',
                                    'Generator', 'Pickup', 'Crane (30T)', 'Crane (50T)', 'Crane (65T)', 'Telehandler', 
                                    'Concrete pump', 'Forklift', 'Stacker', 'Scissor lift', 'Bus', 'Man lift'];
            
            const conditions = ['Good', 'Fair', 'Poor', 'Under Repair', 'Out of Service'];
            
            equipment.forEach(eq => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <select onchange="updateEquipment(${eq.id}, 'type', this.value)">
                            ${equipmentTypes.map(type => `<option value="${type}" ${eq.type === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${eq.quantity}" onchange="updateEquipment(${eq.id}, 'quantity', parseFloat(this.value))"></td>
                    <td><input type="number" value="${eq.hours}" onchange="updateEquipment(${eq.id}, 'hours', parseFloat(this.value))"></td>
                    <td>
                        <select onchange="updateEquipment(${eq.id}, 'condition', this.value)">
                            ${conditions.map(cond => `<option value="${cond}" ${eq.condition === cond ? 'selected' : ''}>${cond}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${eq.remarks}" onchange="updateEquipment(${eq.id}, 'remarks', this.value)"></td>
                    <td><button class="delete-btn" onclick="removeEquipment(${eq.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateEquipment(id, field, value) {
            const eq = equipment.find(e => e.id === id);
            if (eq) eq[field] = value;
        }
        
        // Activities Functions
        function addActivity() {
            const row = {
                id: Date.now(),
                code: '',
                description: '',
                planned: 0,
                actual: 0,
                notes: ''
            };
            activities.push(row);
            renderActivities();
        }
        
        function removeActivity(id) {
            activities = activities.filter(a => a.id !== id);
            renderActivities();
        }
        
        function renderActivities() {
            const tbody = document.getElementById('activityBody');
            tbody.innerHTML = '';
            
            const activityCodes = ['', 'B17', 'B18', 'B20', 'B21', 'FW'];
            
            activities.forEach(act => {
                const variance = (act.actual - act.planned);
                const statusClass = act.actual >= act.planned ? 'status-green' : 
                                   (act.actual >= act.planned * 0.8 ? 'status-amber' : 'status-red');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <select onchange="updateActivity(${act.id}, 'code', this.value)">
                            ${activityCodes.map(code => `<option value="${code}" ${act.code === code ? 'selected' : ''}>${code}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${act.description}" onchange="updateActivity(${act.id}, 'description', this.value)"></td>
                    <td><input type="number" value="${act.planned}" min="0" max="100" onchange="updateActivity(${act.id}, 'planned', parseFloat(this.value))"></td>
                    <td class="${statusClass}"><input type="number" value="${act.actual}" min="0" max="100" onchange="updateActivity(${act.id}, 'actual', parseFloat(this.value))"></td>
                    <td><input type="text" value="${act.notes}" onchange="updateActivity(${act.id}, 'notes', this.value)"></td>
                    <td><button class="delete-btn" onclick="removeActivity(${act.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            updateActivityTotals();
        }
        
        function updateActivity(id, field, value) {
            const act = activities.find(a => a.id === id);
            if (act) {
                act[field] = value;
                renderActivities();
            }
        }
        
        function updateActivityTotals() {
            if (activities.length === 0) {
                document.getElementById('activityTotals').textContent = 'Avg Planned: 0% | Avg Actual: 0% | Variance: 0%';
                return;
            }
            
            const avgPlanned = activities.reduce((sum, a) => sum + (parseFloat(a.planned) || 0), 0) / activities.length;
            const avgActual = activities.reduce((sum, a) => sum + (parseFloat(a.actual) || 0), 0) / activities.length;
            const variance = avgActual - avgPlanned;
            
            document.getElementById('activityTotals').textContent = 
                `Avg Planned: ${avgPlanned.toFixed(1)}% | Avg Actual: ${avgActual.toFixed(1)}% | Variance: ${variance > 0 ? '+' : ''}${variance.toFixed(1)}%`;
        }
        
        // Delays Functions
        function addDelay() {
            const row = {
                id: Date.now(),
                causeType: '',
                description: '',
                impact: '',
                hoursLost: 0,
                affectedActivities: '',
                actionTaken: ''
            };
            delays.push(row);
            renderDelays();
        }
        
        function removeDelay(id) {
            delays = delays.filter(d => d.id !== id);
            renderDelays();
        }
        
        function renderDelays() {
            const tbody = document.getElementById('delayBody');
            tbody.innerHTML = '';
            
            const causeTypes = ['', 'Material Shortage', 'Equipment Breakdown', 'Weather', 'Personnel Absence', 
                               'Design Change', 'Safety Issue', 'Client Delay', 'Subcontractor Delay', 
                               'Permit/Approval Delay', 'Other'];
            const impacts = ['', 'Minor', 'Moderate', 'Severe', 'Critical'];
            
            delays.forEach(delay => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <select onchange="updateDelay(${delay.id}, 'causeType', this.value)">
                            ${causeTypes.map(type => `<option value="${type}" ${delay.causeType === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${delay.description}" onchange="updateDelay(${delay.id}, 'description', this.value)"></td>
                    <td>
                        <select onchange="updateDelay(${delay.id}, 'impact', this.value)">
                            ${impacts.map(imp => `<option value="${imp}" ${delay.impact === imp ? 'selected' : ''}>${imp}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${delay.hoursLost}" onchange="updateDelay(${delay.id}, 'hoursLost', parseFloat(this.value))"></td>
                    <td><input type="text" value="${delay.affectedActivities}" onchange="updateDelay(${delay.id}, 'affectedActivities', this.value)"></td>
                    <td><input type="text" value="${delay.actionTaken}" onchange="updateDelay(${delay.id}, 'actionTaken', this.value)"></td>
                    <td><button class="delete-btn" onclick="removeDelay(${delay.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            updateDelayTotals();
        }
        
        function updateDelay(id, field, value) {
            const delay = delays.find(d => d.id === id);
            if (delay) delay[field] = value;
            if (field === 'hoursLost') updateDelayTotals();
        }
        
        function updateDelayTotals() {
            const totalHoursLost = delays.reduce((sum, d) => sum + (parseFloat(d.hoursLost) || 0), 0);
            document.getElementById('delayTotals').textContent = `Total Hours Lost: ${totalHoursLost.toFixed(1)}`;
        }
        
        // Weather Impact Functions
        function addWeatherImpact() {
            const row = {
                id: Date.now(),
                impactType: '',
                severity: '',
                affectedActivities: '',
                duration: 0,
                mitigation: ''
            };
            weatherImpacts.push(row);
            renderWeatherImpacts();
        }
        
        function removeWeatherImpact(id) {
            weatherImpacts = weatherImpacts.filter(w => w.id !== id);
            renderWeatherImpacts();
        }
        
        function renderWeatherImpacts() {
            const tbody = document.getElementById('weatherImpactBody');
            tbody.innerHTML = '';
            
            const impactTypes = ['', 'Heavy Rain', 'High Winds', 'Extreme Heat', 'Cold', 'Storm', 'Fog', 'Dust Storm', 'Flooding', 'Other'];
            const severities = ['', 'Low', 'Medium', 'High', 'Critical'];
            
            weatherImpacts.forEach(impact => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <select onchange="updateWeatherImpact(${impact.id}, 'impactType', this.value)">
                            ${impactTypes.map(type => `<option value="${type}" ${impact.impactType === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateWeatherImpact(${impact.id}, 'severity', this.value)">
                            ${severities.map(sev => `<option value="${sev}" ${impact.severity === sev ? 'selected' : ''}>${sev}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${impact.affectedActivities}" onchange="updateWeatherImpact(${impact.id}, 'affectedActivities', this.value)"></td>
                    <td><input type="number" value="${impact.duration}" step="0.5" onchange="updateWeatherImpact(${impact.id}, 'duration', parseFloat(this.value))"></td>
                    <td><input type="text" value="${impact.mitigation}" onchange="updateWeatherImpact(${impact.id}, 'mitigation', this.value)"></td>
                    <td><button class="delete-btn" onclick="removeWeatherImpact(${impact.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateWeatherImpact(id, field, value) {
            const impact = weatherImpacts.find(w => w.id === id);
            if (impact) impact[field] = value;
        }
        
        // Materials Functions
        function addMaterial() {
            const row = {
                id: Date.now(),
                materialType: '',
                quantity: 0,
                unit: '',
                notes: ''
            };
            materials.push(row);
            renderMaterials();
        }
        
        function removeMaterial(id) {
            materials = materials.filter(m => m.id !== id);
            renderMaterials();
        }
        
        function renderMaterials() {
            const tbody = document.getElementById('materialBody');
            tbody.innerHTML = '';
            
            const materialTypes = ['', 'Steel plates', 'Rebar', 'Concrete', 'Welding consumables', 'Paint/Coatings', 
                                   'Pipe sections', 'Fasteners', 'Sand/Aggregate', 'Other'];
            const units = ['', 'm²', 'm³', 'tonnes', 'kg', 'pieces', 'liters', 'bags', 'pallets'];
            
            materials.forEach(mat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <select onchange="updateMaterial(${mat.id}, 'materialType', this.value)">
                            ${materialTypes.map(type => `<option value="${type}" ${mat.materialType === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${mat.quantity}" onchange="updateMaterial(${mat.id}, 'quantity', parseFloat(this.value))"></td>
                    <td>
                        <select onchange="updateMaterial(${mat.id}, 'unit', this.value)">
                            ${units.map(unit => `<option value="${unit}" ${mat.unit === unit ? 'selected' : ''}>${unit}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${mat.notes}" onchange="updateMaterial(${mat.id}, 'notes', this.value)"></td>
                    <td><button class="delete-btn" onclick="removeMaterial(${mat.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateMaterial(id, field, value) {
            const mat = materials.find(m => m.id === id);
            if (mat) mat[field] = value;
        }
        
        // Visitors Functions
        function addVisitor() {
            const row = {
                id: Date.now(),
                name: '',
                company: '',
                purpose: '',
                timeOnSite: ''
            };
            visitors.push(row);
            renderVisitors();
        }
        
        function removeVisitor(id) {
            visitors = visitors.filter(v => v.id !== id);
            renderVisitors();
        }
        
        function renderVisitors() {
            const tbody = document.getElementById('visitorBody');
            tbody.innerHTML = '';
            
            visitors.forEach(visitor => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${visitor.name}" onchange="updateVisitor(${visitor.id}, 'name', this.value)"></td>
                    <td><input type="text" value="${visitor.company}" onchange="updateVisitor(${visitor.id}, 'company', this.value)"></td>
                    <td><input type="text" value="${visitor.purpose}" onchange="updateVisitor(${visitor.id}, 'purpose', this.value)"></td>
                    <td><input type="text" value="${visitor.timeOnSite}" placeholder="e.g. 09:00-12:00" onchange="updateVisitor(${visitor.id}, 'timeOnSite', this.value)"></td>
                    <td><button class="delete-btn" onclick="removeVisitor(${visitor.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateVisitor(id, field, value) {
            const visitor = visitors.find(v => v.id === id);
            if (visitor) visitor[field] = value;
        }
        
        // Events Functions
        function addEvent() {
            const row = {
                id: Date.now(),
                eventDate: '',
                description: '',
                type: '',
                source: '',
                costImpact: '',
                liability: '',
                reference: '',
                status: ''
            };
            events.push(row);
            renderEvents();
        }
        
        function removeEvent(id) {
            events = events.filter(e => e.id !== id);
            renderEvents();
        }
        
        function renderEvents() {
            const tbody = document.getElementById('eventBody');
            tbody.innerHTML = '';
            
            const types = ['', 'Design Change', 'Variation Order', 'Client Instruction', 'Engineer Instruction', 
                          'Site Instruction', 'Delay Event', 'Quality Issue', 'Other'];
            const costImpacts = ['', 'None', 'Low (<$5k)', 'Medium ($5k-$25k)', 'High ($25k-$100k)', 'Very High (>$100k)', 'TBD'];
            const liabilities = ['', 'Client', 'Contractor', 'Shared', 'Engineer', 'Force Majeure', 'TBD'];
            const statuses = ['', 'Noted', 'Under Review', 'Priced', 'Approved', 'Rejected', 'Closed'];
            
            events.forEach(event => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="date" value="${event.eventDate}" onchange="updateEvent(${event.id}, 'eventDate', this.value)"></td>
                    <td><input type="text" value="${event.description}" onchange="updateEvent(${event.id}, 'description', this.value)"></td>
                    <td>
                        <select onchange="updateEvent(${event.id}, 'type', this.value)">
                            ${types.map(type => `<option value="${type}" ${event.type === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${event.source}" onchange="updateEvent(${event.id}, 'source', this.value)"></td>
                    <td>
                        <select onchange="updateEvent(${event.id}, 'costImpact', this.value)">
                            ${costImpacts.map(cost => `<option value="${cost}" ${event.costImpact === cost ? 'selected' : ''}>${cost}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateEvent(${event.id}, 'liability', this.value)">
                            ${liabilities.map(liab => `<option value="${liab}" ${event.liability === liab ? 'selected' : ''}>${liab}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" value="${event.reference}" onchange="updateEvent(${event.id}, 'reference', this.value)"></td>
                    <td>
                        <select onchange="updateEvent(${event.id}, 'status', this.value)">
                            ${statuses.map(stat => `<option value="${stat}" ${event.status === stat ? 'selected' : ''}>${stat}</option>`).join('')}
                        </select>
                    </td>
                    <td><button class="delete-btn" onclick="removeEvent(${event.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            updateEventTotals();
        }
        
        function updateEvent(id, field, value) {
            const event = events.find(e => e.id === id);
            if (event) event[field] = value;
            if (field === 'costImpact' || field === 'status') updateEventTotals();
        }
        
        function updateEventTotals() {
            document.getElementById('eventTotals').textContent = `Total Events: ${events.length}`;
        }
        
        // Signature Functions
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // Save Diary Entry
        function saveDiaryEntry() {
            // Validation
            const contractNumber = document.getElementById('contractNumber').value;
            const siteSupervisor = document.getElementById('siteSupervisor').value;
            const projectName = document.getElementById('projectName').value;
            const date = document.getElementById('date').value;
            const confirmAccurate = document.getElementById('confirmAccurate').checked;
            
            if (!contractNumber || !siteSupervisor || !projectName || !date) {
                showMessage('Please fill in all required fields (Contract Number, Site Supervisor, Project Name, Date)', 'error');
                return;
            }
            
            if (!confirmAccurate) {
                showMessage('Please confirm the accuracy of the information by checking the confirmation box', 'error');
                return;
            }
            
            // Collect all data
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                
                // General
                contractNumber: contractNumber,
                siteSupervisor: siteSupervisor,
                projectName: projectName,
                date: date,
                projectLocation: document.getElementById('projectLocation').value,
                
                // Weather (flattened for export)
                weatherCondition: document.getElementById('weatherCondition').value,
                minTemp: document.getElementById('minTemp').value,
                maxTemp: document.getElementById('maxTemp').value,
                windSpeed: document.getElementById('windSpeed').value,
                humidity: document.getElementById('humidity').value,
                rainfall: document.getElementById('rainfall').value,
                rainfallDuration: document.getElementById('rainfallDuration').value,
                
                // Summaries
                workCompleted: document.getElementById('workCompleted').value,
                issuesDelays: document.getElementById('issuesDelays').value,
                
                // Arrays
                personnel: personnel,
                equipment: equipment,
                activities: activities,
                delays: delays,
                
                // Safety
                incidents: document.getElementById('incidents').value,
                safetyInspections: document.getElementById('safetyInspections').value,
                ppeCompliance: document.getElementById('ppeCompliance').value,
                firstAid: document.getElementById('firstAid').value,
                weatherImpacts: weatherImpacts,
                
                // Production
                materials: materials,
                materialsNeeded: document.getElementById('materialsNeeded').value,
                productionIssues: document.getElementById('productionIssues').value,
                visitors: visitors,
                generalComments: document.getElementById('generalComments').value,
                
                // Events
                events: events,
                
                // Signature
                signatureData: canvas.toDataURL(),
                completedBy: document.getElementById('completedBy').value,
                confirmed: confirmAccurate
            };
            
            // Save to localStorage
            let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            entries.push(entry);
            localStorage.setItem('diaryEntries', JSON.stringify(entries));
            
            showMessage('Diary entry saved successfully!', 'success');
            
            // Clear form after 2 seconds
            setTimeout(() => {
                clearForm();
                showMessage('', '');
            }, 2000);
        }
        
        // Show Message
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
            
            if (type) {
                setTimeout(() => {
                    msgDiv.className = 'message';
                }, 5000);
            }
        }
        
        // Clear Form
        function clearForm() {
            document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el => {
                if (el.id !== 'date') el.value = '';
            });
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('confirmAccurate').checked = false;
            clearSignature();
            
            personnel = [];
            equipment = [];
            activities = [];
            delays = [];
            weatherImpacts = [];
            materials = [];
            visitors = [];
            events = [];
            
            renderPersonnel();
            renderEquipment();
            renderActivities();
            renderDelays();
            renderWeatherImpacts();
            renderMaterials();
            renderVisitors();
            renderEvents();
            
            showTab(1);
        }
        
        // Load Entries
        function loadEntries() {
            const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            const listDiv = document.getElementById('entriesList');
            
            if (entries.length === 0) {
                listDiv.innerHTML = '<p>No diary entries yet. Create your first entry!</p>';
                return;
            }
            
            listDiv.innerHTML = '<div style="margin-bottom:20px;"><button onclick="exportAllToExcel()" style="padding:10px 20px;background:#28a745;color:white;border:none;cursor:pointer;margin-right:10px;font-weight:bold;">📥 Export All to Excel</button><button onclick="exportAllToPDF()" style="padding:10px 20px;background:#17a2b8;color:white;border:none;cursor:pointer;font-weight:bold;">📥 Export All to PDF</button></div>';
            
            entries.reverse().forEach(entry => {
                const card = document.createElement('div');
                card.className = 'entry-card';
                card.innerHTML = `
                    <h3>${entry.projectName} - ${entry.date}</h3>
                    <p><strong>Contract:</strong> ${entry.contractNumber}</p>
                    <p><strong>Location:</strong> ${entry.projectLocation}</p>
                    <p><strong>Supervisor:</strong> ${entry.siteSupervisor}</p>
                    <p><strong>Personnel:</strong> ${entry.personnel.length} staff, ${entry.personnel.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0)} hours</p>
                    <p><strong>Equipment:</strong> ${entry.equipment.length} items</p>
                    <p><strong>Activities:</strong> ${entry.activities.length} tracked</p>
                    <p><strong>Submitted:</strong> ${new Date(entry.timestamp).toLocaleString()}</p>
                    <div class="entry-actions">
                        <button onclick="viewEntry(${entry.id})">View Details</button>
                        <button onclick="exportEntryToExcel(${entry.id})" style="background:#28a745;">Export Excel</button>
                        <button onclick="exportEntryToPDF(${entry.id})" style="background:#17a2b8;">Export PDF</button>
                        <button onclick="deleteEntry(${entry.id})">Delete</button>
                    </div>
                `;
                listDiv.appendChild(card);
            });
        }
        
        function viewEntry(id) {
            alert('View detailed entry feature coming in Phase 2. Entry ID: ' + id);
        }
        
        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
                entries = entries.filter(e => e.id !== id);
                localStorage.setItem('diaryEntries', JSON.stringify(entries));
                loadEntries();
                showMessage('Entry deleted successfully', 'success');
            }
        }
        
        // Export Entry to PDF
        function exportEntryToPDF(id) {
            const { jsPDF } = window.jspdf;
            const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            const entry = entries.find(e => e.id === id);
            
            if (!entry) {
                alert('Entry not found');
                return;
            }
            
            const doc = new jsPDF();
            let yPos = 20;
            
            // Title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('CONSTRUCTION DAILY DIARY', 105, yPos, { align: 'center' });
            yPos += 15;
            
            // General Info
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Contract Number: ${entry.contractNumber}`, 20, yPos);
            yPos += 7;
            doc.text(`Date: ${entry.date}`, 20, yPos);
            yPos += 7;
            doc.text(`Site Supervisor: ${entry.siteSupervisor}`, 20, yPos);
            yPos += 7;
            doc.text(`Project: ${entry.projectName}`, 20, yPos);
            yPos += 7;
            doc.text(`Location: ${entry.projectLocation}`, 20, yPos);
            yPos += 12;
            
            // Weather
            doc.setFont(undefined, 'bold');
            doc.text('WEATHER CONDITIONS', 20, yPos);
            yPos += 7;
            doc.setFont(undefined, 'normal');
            doc.text(`Condition: ${entry.weatherCondition}`, 20, yPos);
            yPos += 7;
            doc.text(`Temperature: ${entry.minTemp}°C - ${entry.maxTemp}°C`, 20, yPos);
            yPos += 7;
            doc.text(`Wind: ${entry.windSpeed} km/h | Humidity: ${entry.humidity}%`, 20, yPos);
            yPos += 12;
            
            // Personnel Table
            if (entry.personnel && entry.personnel.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('PERSONNEL ON SITE', 20, yPos);
                yPos += 5;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Name', 'Role Category', 'Role/Title', 'Hours']],
                    body: entry.personnel.map(p => [p.name, p.roleCategory, p.role, p.hours]),
                    theme: 'grid',
                    headStyles: { fillColor: [0, 123, 255] },
                    margin: { left: 20, right: 20 }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
                doc.text(`Total Personnel: ${entry.personnel.length}`, 20, yPos);
                yPos += 7;
                const totalHours = entry.personnel.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0);
                doc.text(`Total Manhours: ${totalHours}`, 20, yPos);
                yPos += 12;
            }
            
            // Check for new page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            // Equipment Table
            if (entry.equipment && entry.equipment.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('EQUIPMENT ON SITE', 20, yPos);
                yPos += 5;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Equipment', 'Type', 'Hours', 'Operator', 'Status']],
                    body: entry.equipment.map(e => [e.name, e.type, e.hours, e.operator, e.status]),
                    theme: 'grid',
                    headStyles: { fillColor: [0, 123, 255] },
                    margin: { left: 20, right: 20 }
                });
                
                yPos = doc.lastAutoTable.finalY + 12;
            }
            
            // Check for new page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            // Work Activities
            if (entry.activities && entry.activities.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('WORK PROGRESS', 20, yPos);
                yPos += 5;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Activity', 'Location', 'Planned', 'Actual', 'Status']],
                    body: entry.activities.map(a => [a.activity, a.location, a.planned, a.actual, a.status]),
                    theme: 'grid',
                    headStyles: { fillColor: [0, 123, 255] },
                    margin: { left: 20, right: 20 }
                });
                
                yPos = doc.lastAutoTable.finalY + 12;
            }
            
            // Check for new page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            // Delays
            if (entry.delays && entry.delays.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('DELAYS', 20, yPos);
                yPos += 5;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Reason', 'Impact', 'Hours Lost', 'Responsible', 'Mitigation']],
                    body: entry.delays.map(d => [d.reason, d.impact, d.hoursLost, d.responsible, d.mitigation]),
                    theme: 'grid',
                    headStyles: { fillColor: [220, 53, 69] },
                    margin: { left: 20, right: 20 }
                });
                
                yPos = doc.lastAutoTable.finalY + 12;
            }
            
            // Check for new page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            // Safety
            doc.setFont(undefined, 'bold');
            doc.text('SAFETY & INCIDENTS', 20, yPos);
            yPos += 7;
            doc.setFont(undefined, 'normal');
            doc.text(`Incidents: ${entry.incidents || 'None'}`, 20, yPos);
            yPos += 7;
            doc.text(`Safety Inspections: ${entry.safetyInspections || 'None'}`, 20, yPos);
            yPos += 7;
            doc.text(`PPE Compliance: ${entry.ppeCompliance || 'N/A'}`, 20, yPos);
            yPos += 12;
            
            // Work Summary
            if (entry.workCompleted) {
                doc.setFont(undefined, 'bold');
                doc.text('WORK COMPLETED SUMMARY', 20, yPos);
                yPos += 7;
                doc.setFont(undefined, 'normal');
                const workLines = doc.splitTextToSize(entry.workCompleted, 170);
                doc.text(workLines, 20, yPos);
                yPos += (workLines.length * 7) + 7;
            }
            
            // Check for new page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            // Issues Summary
            if (entry.issuesDelays) {
                doc.setFont(undefined, 'bold');
                doc.text('ISSUES & DELAYS SUMMARY', 20, yPos);
                yPos += 7;
                doc.setFont(undefined, 'normal');
                const issueLines = doc.splitTextToSize(entry.issuesDelays, 170);
                doc.text(issueLines, 20, yPos);
                yPos += (issueLines.length * 7) + 7;
            }
            
            // Check for new page
            if (yPos > 230) {
                doc.addPage();
                yPos = 20;
            }
            
            // Signature
            if (entry.signatureData) {
                doc.setFont(undefined, 'bold');
                doc.text('DIGITAL SIGNATURE', 20, yPos);
                yPos += 7;
                doc.addImage(entry.signatureData, 'PNG', 20, yPos, 80, 30);
                yPos += 35;
                doc.setFont(undefined, 'normal');
                doc.text(`Completed by: ${entry.completedBy}`, 20, yPos);
            }
            
            // Footer
            doc.setFontSize(8);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 285);
            doc.text(`Entry ID: ${entry.id}`, 150, 285);
            
            // Save
            const fileName = `Daily_Diary_${entry.contractNumber}_${entry.date}.pdf`;
            doc.save(fileName);
        }
        
        // Export All Entries to PDF
        function exportAllToPDF() {
            const { jsPDF } = window.jspdf;
            const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            
            if (entries.length === 0) {
                alert('No entries to export');
                return;
            }
            
            const doc = new jsPDF();
            
            // Title Page
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('DAILY DIARY ENTRIES', 105, 50, { align: 'center' });
            doc.setFontSize(14);
            doc.text(`Complete Report`, 105, 70, { align: 'center' });
            doc.setFont(undefined, 'normal');
            doc.setFontSize(12);
            doc.text(`Total Entries: ${entries.length}`, 105, 90, { align: 'center' });
            doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 100, { align: 'center' });
            
            // Export each entry
            entries.forEach((entry, index) => {
                doc.addPage();
                let yPos = 20;
                
                // Entry header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`Entry ${index + 1} of ${entries.length}`, 105, yPos, { align: 'center' });
                yPos += 10;
                
                // General Info
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Contract: ${entry.contractNumber} | Date: ${entry.date}`, 20, yPos);
                yPos += 7;
                doc.text(`Supervisor: ${entry.siteSupervisor}`, 20, yPos);
                yPos += 7;
                doc.text(`Project: ${entry.projectName}`, 20, yPos);
                yPos += 7;
                doc.text(`Location: ${entry.projectLocation}`, 20, yPos);
                yPos += 12;
                
                // Personnel Summary
                if (entry.personnel && entry.personnel.length > 0) {
                    const totalHours = entry.personnel.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0);
                    doc.setFont(undefined, 'bold');
                    doc.text('PERSONNEL', 20, yPos);
                    yPos += 7;
                    doc.setFont(undefined, 'normal');
                    doc.text(`Total: ${entry.personnel.length} staff | ${totalHours} manhours`, 20, yPos);
                    yPos += 12;
                }
                
                // Equipment Summary
                if (entry.equipment && entry.equipment.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('EQUIPMENT', 20, yPos);
                    yPos += 7;
                    doc.setFont(undefined, 'normal');
                    doc.text(`Total: ${entry.equipment.length} items`, 20, yPos);
                    yPos += 12;
                }
                
                // Work Summary
                if (entry.workCompleted) {
                    doc.setFont(undefined, 'bold');
                    doc.text('WORK COMPLETED', 20, yPos);
                    yPos += 7;
                    doc.setFont(undefined, 'normal');
                    const workLines = doc.splitTextToSize(entry.workCompleted, 170);
                    doc.text(workLines, 20, yPos);
                    yPos += (workLines.length * 7) + 7;
                }
                
                // Issues
                if (entry.issuesDelays) {
                    if (yPos > 240) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFont(undefined, 'bold');
                    doc.text('ISSUES & DELAYS', 20, yPos);
                    yPos += 7;
                    doc.setFont(undefined, 'normal');
                    const issueLines = doc.splitTextToSize(entry.issuesDelays, 170);
                    doc.text(issueLines, 20, yPos);
                }
                
                // Footer
                doc.setFontSize(8);
                doc.text(`Entry ID: ${entry.id}`, 20, 285);
                doc.text(`Submitted: ${new Date(entry.timestamp).toLocaleString()}`, 150, 285);
            });
            
            // Save
            const fileName = `Daily_Diaries_All_Entries_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
        
        // Export Single Entry to Excel
        function exportEntryToExcel(id) {
            const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            const entry = entries.find(e => e.id === id);
            
            if (!entry) {
                alert('Entry not found');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // General Info Sheet
            const generalData = [
                ['CONSTRUCTION DAILY DIARY'],
                [],
                ['Contract Number', entry.contractNumber],
                ['Date', entry.date],
                ['Site Supervisor', entry.siteSupervisor],
                ['Project Name', entry.projectName],
                ['Project Location', entry.projectLocation],
                [],
                ['WEATHER CONDITIONS'],
                ['Condition', entry.weatherCondition],
                ['Min Temperature (°C)', entry.minTemp],
                ['Max Temperature (°C)', entry.maxTemp],
                ['Wind Speed (km/h)', entry.windSpeed],
                ['Humidity (%)', entry.humidity],
                ['Rainfall (mm)', entry.rainfall],
                ['Rainfall Duration (hrs)', entry.rainfallDuration],
                [],
                ['SAFETY STATISTICS'],
                ['Incidents', entry.incidents],
                ['Safety Inspections', entry.safetyInspections],
                ['PPE Compliance', entry.ppeCompliance],
                ['First Aid', entry.firstAid],
                [],
                ['WORK COMPLETED SUMMARY'],
                [entry.workCompleted || ''],
                [],
                ['ISSUES & DELAYS SUMMARY'],
                [entry.issuesDelays || ''],
                [],
                ['GENERAL COMMENTS'],
                [entry.generalComments || ''],
                [],
                ['Completed By', entry.completedBy],
                ['Timestamp', new Date(entry.timestamp).toLocaleString()]
            ];
            const wsGeneral = XLSX.utils.aoa_to_sheet(generalData);
            XLSX.utils.book_append_sheet(wb, wsGeneral, 'General');
            
            // Personnel Sheet
            if (entry.personnel && entry.personnel.length > 0) {
                const personnelData = [
                    ['PERSONNEL ON SITE'],
                    ['Name', 'Role Category', 'Role/Title', 'Hours'],
                    ...entry.personnel.map(p => [p.name, p.roleCategory, p.role, p.hours]),
                    [],
                    ['Total Personnel', entry.personnel.length],
                    ['Total Manhours', entry.personnel.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0)]
                ];
                const wsPersonnel = XLSX.utils.aoa_to_sheet(personnelData);
                XLSX.utils.book_append_sheet(wb, wsPersonnel, 'Personnel');
            }
            
            // Equipment Sheet
            if (entry.equipment && entry.equipment.length > 0) {
                const equipmentData = [
                    ['EQUIPMENT ON SITE'],
                    ['Equipment', 'Type', 'Hours', 'Operator', 'Status'],
                    ...entry.equipment.map(e => [e.name, e.type, e.hours, e.operator, e.status])
                ];
                const wsEquipment = XLSX.utils.aoa_to_sheet(equipmentData);
                XLSX.utils.book_append_sheet(wb, wsEquipment, 'Equipment');
            }
            
            // Work Activities Sheet
            if (entry.activities && entry.activities.length > 0) {
                const activitiesData = [
                    ['WORK PROGRESS'],
                    ['Activity', 'Location', 'Planned', 'Actual', 'Status', 'Comments'],
                    ...entry.activities.map(a => [a.activity, a.location, a.planned, a.actual, a.status, a.comments])
                ];
                const wsActivities = XLSX.utils.aoa_to_sheet(activitiesData);
                XLSX.utils.book_append_sheet(wb, wsActivities, 'Work Progress');
            }
            
            // Delays Sheet
            if (entry.delays && entry.delays.length > 0) {
                const delaysData = [
                    ['DELAYS'],
                    ['Reason', 'Impact', 'Hours Lost', 'Responsible', 'Mitigation'],
                    ...entry.delays.map(d => [d.reason, d.impact, d.hoursLost, d.responsible, d.mitigation]),
                    [],
                    ['Total Hours Lost', entry.delays.reduce((sum, d) => sum + (parseFloat(d.hoursLost) || 0), 0)]
                ];
                const wsDelays = XLSX.utils.aoa_to_sheet(delaysData);
                XLSX.utils.book_append_sheet(wb, wsDelays, 'Delays');
            }
            
            // Weather Impacts Sheet
            if (entry.weatherImpacts && entry.weatherImpacts.length > 0) {
                const weatherData = [
                    ['WEATHER IMPACTS'],
                    ['Weather Type', 'Activities Affected', 'Hours Lost', 'Mitigation'],
                    ...entry.weatherImpacts.map(w => [w.weatherType, w.affectedActivities, w.hoursLost, w.mitigation])
                ];
                const wsWeather = XLSX.utils.aoa_to_sheet(weatherData);
                XLSX.utils.book_append_sheet(wb, wsWeather, 'Weather Impacts');
            }
            
            // Materials Sheet
            if (entry.materials && entry.materials.length > 0) {
                const materialsData = [
                    ['MATERIALS RECEIVED'],
                    ['Material', 'Quantity', 'Unit', 'Supplier', 'Date Received'],
                    ...entry.materials.map(m => [m.material, m.quantity, m.unit, m.supplier, m.dateReceived])
                ];
                const wsMaterials = XLSX.utils.aoa_to_sheet(materialsData);
                XLSX.utils.book_append_sheet(wb, wsMaterials, 'Materials');
            }
            
            // Visitors Sheet
            if (entry.visitors && entry.visitors.length > 0) {
                const visitorsData = [
                    ['VISITORS'],
                    ['Name', 'Company', 'Purpose', 'Time In', 'Time Out'],
                    ...entry.visitors.map(v => [v.name, v.company, v.purpose, v.timeIn, v.timeOut])
                ];
                const wsVisitors = XLSX.utils.aoa_to_sheet(visitorsData);
                XLSX.utils.book_append_sheet(wb, wsVisitors, 'Visitors');
            }
            
            // Events Sheet
            if (entry.events && entry.events.length > 0) {
                const eventsData = [
                    ['EVENTS'],
                    ['Description', 'From Whom', 'Cost Impact', 'Whose Cost'],
                    ...entry.events.map(e => [e.description, e.fromWhom, e.costImpact, e.whoseCost])
                ];
                const wsEvents = XLSX.utils.aoa_to_sheet(eventsData);
                XLSX.utils.book_append_sheet(wb, wsEvents, 'Events');
            }
            
            // Save
            const fileName = `Daily_Diary_${entry.contractNumber}_${entry.date}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // Export All Entries to Excel
        function exportAllToExcel() {
            const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            
            if (entries.length === 0) {
                alert('No entries to export');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Summary Sheet
            const summaryData = [
                ['DAILY DIARY ENTRIES - COMPLETE REPORT'],
                [],
                ['Total Entries', entries.length],
                ['Generated', new Date().toLocaleString()],
                [],
                ['Entry #', 'Date', 'Contract', 'Project', 'Location', 'Supervisor', 'Personnel', 'Manhours', 'Equipment', 'Activities']
            ];
            
            entries.forEach((entry, index) => {
                const totalHours = entry.personnel ? entry.personnel.reduce((sum, p) => sum + (parseFloat(p.hours) || 0), 0) : 0;
                summaryData.push([
                    index + 1,
                    entry.date,
                    entry.contractNumber,
                    entry.projectName,
                    entry.projectLocation,
                    entry.siteSupervisor,
                    entry.personnel ? entry.personnel.length : 0,
                    totalHours,
                    entry.equipment ? entry.equipment.length : 0,
                    entry.activities ? entry.activities.length : 0
                ]);
            });
            
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
            
            // All Personnel Combined
            const allPersonnel = [['Date', 'Contract', 'Project', 'Name', 'Role Category', 'Role/Title', 'Hours']];
            entries.forEach(entry => {
                if (entry.personnel) {
                    entry.personnel.forEach(p => {
                        allPersonnel.push([entry.date, entry.contractNumber, entry.projectName, p.name, p.roleCategory, p.role, p.hours]);
                    });
                }
            });
            if (allPersonnel.length > 1) {
                const wsPersonnel = XLSX.utils.aoa_to_sheet(allPersonnel);
                XLSX.utils.book_append_sheet(wb, wsPersonnel, 'All Personnel');
            }
            
            // All Equipment Combined
            const allEquipment = [['Date', 'Contract', 'Project', 'Equipment', 'Type', 'Hours', 'Operator', 'Status']];
            entries.forEach(entry => {
                if (entry.equipment) {
                    entry.equipment.forEach(e => {
                        allEquipment.push([entry.date, entry.contractNumber, entry.projectName, e.name, e.type, e.hours, e.operator, e.status]);
                    });
                }
            });
            if (allEquipment.length > 1) {
                const wsEquipment = XLSX.utils.aoa_to_sheet(allEquipment);
                XLSX.utils.book_append_sheet(wb, wsEquipment, 'All Equipment');
            }
            
            // All Activities Combined
            const allActivities = [['Date', 'Contract', 'Project', 'Activity', 'Location', 'Planned', 'Actual', 'Status', 'Comments']];
            entries.forEach(entry => {
                if (entry.activities) {
                    entry.activities.forEach(a => {
                        allActivities.push([entry.date, entry.contractNumber, entry.projectName, a.activity, a.location, a.planned, a.actual, a.status, a.comments]);
                    });
                }
            });
            if (allActivities.length > 1) {
                const wsActivities = XLSX.utils.aoa_to_sheet(allActivities);
                XLSX.utils.book_append_sheet(wb, wsActivities, 'All Activities');
            }
            
            // All Delays Combined
            const allDelays = [['Date', 'Contract', 'Project', 'Reason', 'Impact', 'Hours Lost', 'Responsible', 'Mitigation']];
            entries.forEach(entry => {
                if (entry.delays) {
                    entry.delays.forEach(d => {
                        allDelays.push([entry.date, entry.contractNumber, entry.projectName, d.reason, d.impact, d.hoursLost, d.responsible, d.mitigation]);
                    });
                }
            });
            if (allDelays.length > 1) {
                const wsDelays = XLSX.utils.aoa_to_sheet(allDelays);
                XLSX.utils.book_append_sheet(wb, wsDelays, 'All Delays');
            }
            
            // Save
            const fileName = `Daily_Diaries_All_Entries_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>

